<md-card md-theme="light">
  <md-tabs class="kb-main-tabs" md-dynamic-height="true" md-border-bottom="true" >
    <md-tab label="{{ 'My risk analysis' | translate }}">
      <md-card-content>
          <md-list ng-if="clientAnrs.length > 0 && isAllowed('userfo')">
              <md-list-item class="md-3-line" ui-sref="main.project.anr({modelId: anr.id})" ng-repeat="anr in clientAnrs">
                  <div class="md-list-item-text">
                      <h3>{{ anr['label' + anr.language] }}</h3>
                      <p>{{ anr['description' + anr.language] }} - <span translate>Created by</span> {{ anr['creator'] }}</p>
                      <p translate>Created at {{ anr['createdAt']['date'].replace(' ', 'T') | date:'short' }}</p>
                  </div>
                  <md-button class="md-icon-button" title="{{ languagesNames[anr['language']] }}" ui-sref="main.project.anr({modelId: anr.id})">
                      <countryflag country="{{ countriesCode[anr['language']] }}"></countryflag>
                  </md-button>
                  <md-button layout="row" class="md-icon-button" style="width: 70px" ng-attr-title="{{ (anr.rwd ? 'Read and write'  : 'Read') | translate }}" ui-sref="main.project.anr({modelId: anr.id})">
                      <md-icon class="md-primary">visibility</md-icon>
                      <md-button  class="md-primary md-icon-button" ng-disabled="!anr.rwd" ng-click="deleteClientAnrGlobal($event, anr)">
                        <md-icon>edit</md-icon>
                      </md-button>
                  </md-button>
                  <md-button  class="md-warn md-icon-button " ng-disabled="!anr.rwd" ng-click="deleteClientAnrGlobal($event, anr)" title="{{ 'Delete' | translate }}">
                    <md-icon>delete</md-icon>
                  </md-button>
              </md-list-item>
          </md-list>

          <p class="md-subhead" ng-if="!clientAnrs || clientAnrs.length == 0" translate>You don't have any risk analysis yet.</p>
      </md-card-content>

      <md-card-content>
          <div layout="row" layout-align="right center" class="md-padding">
              <img ng-if="checkVersion" ng-src="{{ appCheckingURL }}?version={{ encryptedAppVersion }}&timestamp={{ appVersionCheckingTimestamp }}" ng-attr-title="{{ 'State of your MONARC instance.' | translate }}"></img>
          </div>
      </md-card-content>
    </md-tab>
    <md-tab label="{{ 'Global dashboard' | translate }}" ng-if="isAllowed('ceo')" ng-init="updateGlobalDashboard()">
      <md-tabs md-dynamic-height="true" md-border-bottom="true">
          <nvd3 id="loadPptx" options="initOptionPptx" data="initDataPptx"  api="loadPptx" config="{refreshDataOnly: true}" ng-show="false"></nvd3>
          <div style="margin-right: 50px" ng-if="loadingPptx">
            <md-progress-circular md-indeterminate="true"></md-progress-circular>
          </div>
          <md-menu style="margin-right: 50px" ng-if="!loadingPptx">
            <md-button class="md-icon-button" ng-click="$mdMenu.open()" ng-disabled="!dashboard.riskInfo || !loadCompliance" >
                <md-icon class="md-warn" >file_download</md-icon><md-tooltip>{{ 'Export' | translate }}</md-tooltip>
            </md-button>
            <md-menu-content>
              <md-menu-item>
                <md-button ng-click="generatePptxSildes()">.pptx</md-button>
              </md-menu-item>
              <md-menu-item>
                <md-button ng-click="generateXlsxData()">.xlsx</md-button>
              </md-menu-item>
          </md-menu>
          <md-button class="md-icon-button" ng-click="settingsGlobalDashboard($event)">
              <md-icon class="md-primary" >settings</md-icon><md-tooltip>{{ 'Settings' | translate }}</md-tooltip>
          </md-button>
          <md-tab label="{{ 'Information risks' | translate }}" md-on-select="selectGraphRisks()">
            <div layout="row" layout-align="space-around">
              <div layout="column" flex="40">
                  <meta name="viewport" content="width=device-width, initial-scale=1">
                  <p class="md-title" translate>Current risks</p>
                  <div layout="row" layout-align="start center">
                    <md-input-container class="tight-margin">
                        <label translate >Chart type</label>
                        <md-select ng-model="risksOptions.current.chartType" >
                            <md-option value="vertical" selected>{{ 'Vertical Bar Chart' | translate }}</md-option>
                            <md-option value="horizontal">{{ 'Horizontal Bar Chart' | translate }}</md-option>
                            <md-option value="line">{{ 'Line Chart' | translate }}</md-option>
                        </md-select>
                    </md-input-container>

                    <md-input-container class="tight-margin" flex="50">
                      <label translate >filter by analysis</label>
                      <md-select id="filterByAnr" ng-model="currentFilter" placeholder="filter by analysis" multiple>
                        <md-option class="filter-categories-graphGlobalCurrentRisks" ng-value="category" ng-repeat="category in categories track by $index" selected>{{category}}</md-option>
                      </md-select>
                    </md-input-container>

                    <md-button class="md-icon-button " title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphGlobalCurrentRisks', 'currentRisksChart' + risksOptions.current.chartType)">
                        <md-icon class="md-warn">file_download</md-icon>
                    </md-button>
                  </div>

                  <div layout="row" ng-show="risksOptions.current.chartType=='line'">
                    <md-input-container class="tight-margin">
                      <label translate>Start Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="risksOptions.current.startDate"
                        ng-change="dateChanged('risksOptions.current','startDate')"
                        md-max-date="risksOptions.current.maxDate">
                      </md-datepicker>
                    </md-input-container>

                    <md-input-container class="tight-margin">
                      <label translate>End Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="risksOptions.current.endDate"
                        ng-change="dateChanged('risksOptions.current','endDate')"
                        md-min-date="risksOptions.current.minDate"
                        md-max-date="today">
                      </md-datepicker>
                    </md-input-container>
                  </div>

                  <div layout="row" layout-align="start center">
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalCurrentRisks" class="chartMode-graphGlobalCurrentRisks" value="stacked" checked>Stacked
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalCurrentRisks" class="chartMode-graphGlobalCurrentRisks" value="grouped">Grouped
                  </div>
                  <d3 id="graphGlobalCurrentRisks"></d3>
              </div>
              <div layout="column" flex="40">
                  <p class="md-title" translate>Residual risks</p>
                  <div layout="row" layout-align="start center">
                      <md-input-container class="tight-margin">
                          <label translate>Display residual risks by</label>
                          <md-select ng-model="risksOptions.residual.chartType">
                            <md-option value="vertical" selected>{{ 'Vertical Bar Chart' | translate }}</md-option>
                            <md-option value="horizontal">{{ 'Horizontal Bar Chart' | translate }}</md-option>
                            <md-option value="line">{{ 'Line Chart' | translate }}</md-option>
                          </md-select>
                      </md-input-container>

                      <md-input-container class="tight-margin" flex="50" >
                        <label translate >filter by analysis</label>
                        <md-select ng-model="residualFilter" placeholder="filter by analysis" multiple>
                          <md-option class="filter-categories-graphGlobalResidualRisks" ng-value="category" ng-repeat="category in categories track by $index" selected>{{category}}</md-option>
                        </md-select>
                      </md-input-container>

                      <md-button class="md-icon-button" title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphGlobalResidualRisks', 'residualRisksChart' + risksOptions.residual.chartType)">
                          <md-icon class="md-warn">file_download</md-icon>
                      </md-button>
                  </div>

                  <div layout="row" ng-show="risksOptions.residual.chartType=='line'">
                    <md-input-container class="tight-margin">
                      <label translate>Start Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="risksOptions.residual.startDate"
                        ng-change="dateChanged('risksOptions.residual','startDate')"
                        md-max-date="risksOptions.residual.maxDate">
                      </md-datepicker>
                    </md-input-container>

                    <md-input-container class="tight-margin">
                      <label translate>End Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="risksOptions.residual.endDate"
                        ng-change="dateChanged('risksOptions.residual','endDate')"
                        md-min-date="risksOptions.residual.minDate"
                        md-max-date="today">
                      </md-datepicker>
                    </md-input-container>
                  </div>

                  <div layout="row" layout-align="start center">
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalResidualRisks" class="chartMode-graphGlobalResidualRisks" value="stacked" checked>Stacked
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalResidualRisks" class="chartMode-graphGlobalResidualRisks" value="grouped">Grouped
                  </div>
                  <d3 id="graphGlobalResidualRisks"></d3>
            </div>
          </md-tab>

          <md-tab label="{{ 'Operational risks' | translate }}" md-on-select="selectGraphOpRisks()">
            <div layout="row" layout-align="space-around">
              <div layout="column" flex="40">
                  <meta name="viewport" content="width=device-width, initial-scale=1">
                  <p class="md-title" translate>Current risks</p>
                  <div layout="row" layout-align="start center">
                    <md-input-container class="tight-margin">
                        <label translate >Chart type</label>
                        <md-select ng-model="opRisksOptions.current.chartType" >
                            <md-option value="vertical" selected>{{ 'Vertical Bar Chart' | translate }}</md-option>
                            <md-option value="horizontal">{{ 'Horizontal Bar Chart' | translate }}</md-option>
                            <md-option value="line">{{ 'Line Chart' | translate }}</md-option>
                        </md-select>
                    </md-input-container>

                    <md-input-container class="tight-margin" flex="50">
                      <label translate >filter by analysis</label>
                      <md-select ng-model="currentFilter" placeholder="filter by analysis" multiple>
                        <md-option class="filter-categories-graphGlobalCurrentOpRisks" ng-value="category" ng-repeat="category in categories track by $index" selected>{{category}}</md-option>
                      </md-select>
                    </md-input-container>

                    <md-button class="md-icon-button " title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphGlobalCurrentOpRisks', 'currentRisksChart' + opRisksOptions.current.chartType)">
                        <md-icon class="md-warn">file_download</md-icon>
                    </md-button>
                  </div>

                  <div layout="row" ng-show="opRisksOptions.current.chartType=='line'">
                    <md-input-container class="tight-margin">
                      <label translate>Start Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="opRisksOptions.current.startDate"
                        ng-change="dateChanged('opRisksOptions.current','startDate')"
                        md-max-date="opRisksOptions.current.maxDate">
                      </md-datepicker>
                    </md-input-container>

                    <md-input-container class="tight-margin">
                      <label translate>End Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="opRisksOptions.current.endDate"
                        ng-change="dateChanged('opRisksOptions.current','endDate')"
                        md-min-date="opRisksOptions.current.minDate"
                        md-max-date="today">
                      </md-datepicker>
                    </md-input-container>
                  </div>

                  <div layout="row" layout-align="start center">
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalCurrentOpRisks" class="chartMode-graphGlobalCurrentOpRisks" value="stacked" checked>Stacked
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalCurrentOpRisks" class="chartMode-graphGlobalCurrentOpRisks" value="grouped">Grouped
                  </div>
                  <d3 id="graphGlobalCurrentOpRisks"></d3>
              </div>
              <div layout="column" flex="40">
                  <p class="md-title" translate>Residual risks</p>
                  <div layout="row" layout-align="start center">
                      <md-input-container class="tight-margin">
                          <label translate>Display residual risks by</label>
                          <md-select ng-model="opRisksOptions.residual.chartType">
                            <md-option value="vertical" selected>{{ 'Vertical Bar Chart' | translate }}</md-option>
                            <md-option value="horizontal">{{ 'Horizontal Bar Chart' | translate }}</md-option>
                            <md-option value="line">{{ 'Line Chart' | translate }}</md-option>
                          </md-select>
                      </md-input-container>

                      <md-input-container class="tight-margin" flex="50" >
                        <label translate >filter by analysis</label>
                        <md-select ng-model="residualFilter" placeholder="filter by analysis" multiple>
                          <md-option class="filter-categories-graphGlobalResidualOpRisks" ng-value="category" ng-repeat="category in categories track by $index" selected>{{category}}</md-option>
                        </md-select>
                      </md-input-container>

                      <md-button class="md-icon-button" title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphGlobalResidualOpRisks', 'residualRisksChart' + opRisksOptions.residual.chartType)">
                          <md-icon class="md-warn">file_download</md-icon>
                      </md-button>
                  </div>

                  <div layout="row" ng-show="opRisksOptions.residual.chartType=='line'">
                    <md-input-container class="tight-margin">
                      <label translate>Start Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="opRisksOptions.residual.startDate"
                        ng-change="dateChanged('opRisksOptions.residual','startDate')"
                        md-max-date="opRisksOptions.residual.maxDate">
                      </md-datepicker>
                    </md-input-container>

                    <md-input-container class="tight-margin">
                      <label translate>End Date</label>
                      <md-datepicker
                        md-open-on-focus
                        md-hide-icons="calendar"
                        md-current-view="year"
                        ng-model="opRisksOptions.residual.endDate"
                        ng-change="dateChanged('opRisksOptions.residual','endDate')"
                        md-min-date="opRisksOptions.residual.minDate"
                        md-max-date="today">
                      </md-datepicker>
                    </md-input-container>
                  </div>

                  <div layout="row" layout-align="start center">
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalResidualOpRisks" class="chartMode-graphGlobalResidualOpRisks" value="stacked" checked>Stacked
                    <input style="margin-top: 0;" type="radio" name="chartMode-graphGlobalResidualOpRisks" class="chartMode-graphGlobalResidualOpRisks" value="grouped">Grouped
                  </div>
                  <d3 id="graphGlobalResidualOpRisks"></d3>
            </div>
          </md-tab>

          <md-tab label="{{ 'Threats' | translate }}" md-on-select="selectGraphThreats()">
            <div layout="row" layout-align="start center" flex="60" class="md-padding-left">
                <md-input-container flex>
                    <label translate>Display threats by</label>
                    <md-select ng-model="threatOptions.displayBy">
                      <md-option value="averageRate" selected>{{ 'Probability' | translate }}</md-option>
                        <md-option value="count">{{ 'Number' | translate }}</md-option>
                        <md-option value="maxRisk" >{{ 'Max. associated risk level' | translate }}</md-option>
                    </md-select>
                </md-input-container>

                <md-input-container flex>
                    <label translate>Chart type</label>
                    <md-select ng-model="threatOptions.chartType">
                        <md-option value="overview" selected>{{ 'Overview' | translate }}</md-option>
                        <md-option value="line">{{ 'Line chart' | translate }}</md-option>
                    </md-select>
                </md-input-container>

                <md-input-container ng-show ="threatOptions.chartType=='line'" flex>
                  <label translate>Threat</label>
                  <md-select ng-model="threatOptions.threat">
                    <md-option ng-repeat="threat in threats" ng-value="threat">
                      {{threat}}
                    </md-option>
                  </md-select>
                </md-input-container>

                <md-input-container>
                  <label translate>Start Date</label>
                  <md-datepicker
                    md-open-on-focus
                    md-hide-icons="calendar"
                    md-current-view="year"
                    ng-model="threatOptions.startDate"
                    ng-change="dateChanged('threatOptions','startDate')"
                    md-max-date="threatOptions.maxDate">
                  </md-datepicker>
                </md-input-container>

                <md-input-container>
                  <label translate>End Date</label>
                  <md-datepicker
                    md-open-on-focus
                    md-hide-icons="calendar"
                    md-current-view="year"
                    ng-model="threatOptions.endDate"
                    ng-change="dateChanged('threatOptions','endDate')"
                    md-min-date="threatOptions.minDate"
                    md-max-date="today">
                  </md-datepicker>
                </md-input-container>


                <md-button class="md-icon-button " title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphGlobalThreats', 'threatsChartBy' + threatOptions.displayBy + threatOptions.chartType)">
                    <md-icon class="md-warn">file_download</md-icon>
                </md-button>
            </div>

            <d3 id="graphGlobalThreats"></d3>
          </md-tab>

          <md-tab label="{{ 'Vulnerabilities' | translate }}" md-on-select="selectGraphVulnerabilities()">
            <div layout="row" layout-align="start center" flex="50" class="md-padding-left">
                <md-input-container flex>
                    <label translate>Display vulnerabilities by</label>
                    <md-select ng-model="displayVulnerabilitiesBy">
                        <md-option value="number" selected>{{ 'Number' | translate }}</md-option>
                        <md-option value="qualification" >{{ 'Qualification' | translate }}</md-option>
                        <md-option value="max_associated_risk">{{ 'Max. associated risk level' | translate }}</md-option>
                    </md-select>
                </md-input-container>

                <md-input-container flex>
                    <label translate>Number of vulnerabilities to display</label>
                    <md-select ng-model="dashboard.vulnerabilitiesDisplayed">
                        <md-option value="5" > 5 </md-option>
                        <md-option value="10" > 10 </md-option>
                        <md-option value="15" > 15 </md-option>
                        <md-option value="20" selected> 20 </md-option>
                        <md-option value="25" > 25 </md-option>
                        <md-option value="30" > 30 </md-option>
                        <md-option value="all" > {{ 'All' | translate }} </md-option>
                    </md-select>
                </md-input-container>

                <md-input-container flex>
                    <label translate>Chart type</label>
                    <md-select ng-model="vulnerabilitiesChartOption">
                        <md-option value="optionsChartVulnerabilities_discreteBarChart" selected> {{ 'Discrete Bar Chart' | translate }} </md-option>
                        <md-option value="optionsChartVulnerabilities_horizontalBarChart" > {{ 'Horizontal Bar Chart' | translate }} </md-option>
                    </md-select>
                </md-input-container>

                <md-button class="md-icon-button " title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphVulnerabilities', 'vulnerabilitiesChartBy' + displayVulnerabilitiesBy)">
                    <md-icon class="md-warn">file_download</md-icon>
                </md-button>
            </div>

            <div layout="row" layout-align="start center">
              <input style="margin-top: 0;" type="radio" name="optionChartMode" class="chartMode-HorizBarChart" value="grouped" checked>Grouped
              <input style="margin-top: 0;" type="radio" name="optionChartMode" class="chartMode-HorizBarChart" value="stacked">Stacked
              <md-select style="margin-left: 30px;" placeholder="{{filterCatVuln.length ?  filterCatVuln.length + ' selected' : 'filter by analysis'}}" ng-model="categories" multiple>
                <div ng-repeat="category in categories track by $index">
                  <input type="checkbox" class="filter-categories-HorizBarChart" value="{{category}}" checked>
                    <label>{{category}}</label><br>
                </div>
              </md-select>
            </div>
            <d3 id="graphHorizBarChart"></d3>

          </md-tab>

          <md-tab label="{{ 'Cartography' | translate }}" md-on-select="selectGraphCartography()">
            <div layout="row" layout-align="start center" flex="25" class="md-padding-left">
                <md-input-container flex>
                    <label translate>Type of risks</label>
                    <md-select ng-model="cartographyRisksType">
                        <md-option value="info_risks" ng-disabled="!dashboard.riskInfo" selected>{{ 'Information risks' | translate }}</md-option>
                        <md-option value="op_risks" ng-disabled="!dashboard.riskOp" >{{ 'Operational risks' | translate }}</md-option>
                    </md-select>
                </md-input-container>


            </div>
            <div layout="row" layout-align="start center">
              <div layout="column" layout-align="start center" flex>
                <div layout="row" layout-align="start center">
                  <p class="md-title" translate>Current risks</p>
                  <md-button class="md-icon-button " title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphCartographyCurrent', 'cartographyChartCurrentBy' + cartographyRisksType)">
                      <md-icon class="md-warn">file_download</md-icon>
                  </md-button>
                </div>
                <d3 id="graphHeatmapChart"></d3>
              </div>
              <div layout="column" layout-align="start center" flex>
                <div layout="row" layout-align="start center">
                  <p class="md-title" translate>Residual risks</p>
                  <md-button class="md-icon-button " title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphCartographyTarget', 'cartographyChartTargetBy' + cartographyRisksType)">
                      <md-icon class="md-warn">file_download</md-icon>
                  </md-button>
                </div>
              </div>
            </div>


          </md-tab>

          <md-tab label="{{ 'Compliance' | translate }}" md-on-select="selectGraphCompliance()">
            <div layout="row" layout-align="start center" flex="25" class="md-padding-left">
              <md-input-container flex>
                  <label translate>Display compliance of</label>
                  <md-select ng-model="dashboard.refSelected">
                    <md-option ng-repeat="ref in dashboard.referentials" ng-value="ref.uuid">
                      {{ _langField(ref,'label') }}
                    </md-option>
                  </md-select>
              </md-input-container>

              <md-button class="md-icon-button " title="{{ 'Export (PNG)' | translate }}" ng-click="exportAsPNG('graphCompliance', 'ComplianceChart')">
                  <md-icon class="md-warn">file_download</md-icon>
              </md-button>
              <md-button id="goBack" class="md-icon-button" title="{{ 'Go back' | translate }}" ng-click="goBackChartCompliance()">
                  <md-icon class="md-primary">arrow_back</md-icon>
              </md-button>
            </div>
            <d3 layout="row" layout-align="center center" id="graphRadarChart"></d3>
          </md-tab>

          <!--<md-tab label="{{ 'Perspective' | translate }}" md-on-select="selectGraphPerspective()">
          </md-tab>-->
      </md-tabs>
    </md-tab>
  </md-tabs>
</md-card>
